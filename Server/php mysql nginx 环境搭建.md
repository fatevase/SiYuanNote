{: id="20210130023144-6e1p4sn"}

### 安装 php7
{: id="20210130001815-ry9wdu3"}

ubuntu 20.04 使用 `apt install php` 自动会安装 php7.4
{: id="20210130001904-2gh1nh9"}

php 的官方镜像分为三个分支：
{: id="20210130022927-zx1lk74"}

* {: id="20210130022927-kjd15d9"}`cli` ：没有开启 CGI，也就是不能运行 fpm，只能运行命令行。
* {: id="20210130022927-0t1ow67"}`fpm` ：开启了 CGI，可以用来运行 web 服务也可以运行 cli 命令。
* {: id="20210130022927-rhe45ko"}`zts` ：开启了线程安全的版本。
{: id="20210130022927-5fpfchq"}

一般来说，lnmp 环境使用 `fpm` 即可。
{: id="20210130022927-gtor1bq"}

也可以使用
{: id="20210130002013-y6j6wuu"}

```shell
# 指定安装版本的cli
apt install php7.4-cli

# php拓展
sudo -y apt install php7.4-fpm php7.4-mysql php7.4-curl php7.4-json php7.4-mbstring php7.4-xml php7.4-intl
```
{: id="20210130002019-0tlkl1g"}

{: id="20210130113049-asl9tzj"}

通过 `ps aux|grep php`,检查 php-fpm 服务有没有启动,没有启动手动启动下该服务 `/etc/init.d/php-fom7.4 start`.
{: id="20210130002234-aqzoayw"}

{: id="20210130113051-y1fa8sm"}

ubuntu 20.04 使用 `apt install mysql-server mysql-client` 自动会安装 5.7 版本,
{: id="20210130002510-pie30mp"}

先检查下自己有没有安装 php-mysql 扩展,`apt list php-mysql`, 如果没有显示则手动安装扩展
{: id="20210130010724-oajb94r"}

`apt install php-mysql`
{: id="20210130010815-86crero"}

{: id="20210130023159-qrkaq9w"}

### 安装 nginx
{: id="20210130023200-59j4ef0"}

```shell
apt install nginx

# 请确保80端口没有被其他服务占用
/etc/init.d/nginx start

# 测试配置文件是否正常
nginx -t

nginx           #启动
nginx -s reload #重新加载配置文件
nginx -s quit   #优雅退出
nginx -s stop   #立即停止
nginx -t        #验证配置文件
```
{: id="20210130023200-nwzekp0"}

Ubuntu 安装之后的文件结构大致为:
{: id="20210130023200-1rnjvfg"}

* {: id="20210130023200-fs68b9e"}所有的配置文件都在/etc/nginx 下,并且每个虚拟主机已经安排在了/etc/nginx/sites-available 下
* {: id="20210130023200-20fo1x5"}程序文件在/usr/sbin/nginx * 日志放在了/var/log/nginx 中
* {: id="20210130023200-bcc0wf6"}并已经在/etc/init.d/下创建了启动脚本 nginx
* {: id="20210130023200-7jbpm3n"}默认的虚拟主机的目录设置在了/var/www/nginx-default
{: id="20210130023200-ib6uxor"}

nginx 安装好之后，会创建/etc/nginx/conf.d/default.conf 文件，里面记录网站的配置信息。
{: id="20210130023200-bk5oykr"}

{: id="20210130023200-cer8ow3"}

```
server {
        listen 80 default_server;
        listen [::]:80 default_server;

        # SSL configuration
        #
        # listen 443 ssl default_server;
        # listen [::]:443 ssl default_server;
        #
        # Note: You should disable gzip for SSL traffic.
        # See: https://bugs.debian.org/773332
        #
        # Read up on ssl_ciphers to ensure a secure configuration.
        # See: https://bugs.debian.org/765782
        #
        # Self signed certs generated by the ssl-cert package
        # Don't use them in a production server!
        #
        # include snippets/snakeoil.conf;

        root /var/www/html;

        # Add index.php to the list if you are using PHP
        index index.html index.htm index.nginx-debian.html index.php;

        server_name _;

        location / {
                # First attempt to serve request as file, then
                # as directory, then fall back to displaying a 404.
                try_files $uri $uri/ =404;
        }

        # pass PHP scripts to FastCGI server
        #
        location ~ \.php$ {
                include snippets/fastcgi-php.conf;
        #
        #       # With php-fpm (or other unix sockets):
	#	此处路径为对于php-fpm下的wwww.conf中的监听路径
                fastcgi_pass unix:/run/php/php7.4-fpm.sock;
        #       # With php-cgi (or other tcp sockets):
        #       fastcgi_pass 127.0.0.1:9000;
        }

        # deny access to .htaccess files, if Apache's document root
        # concurs with nginx's one
        #
        #location ~ /\.ht {
        #       deny all;
        #}
}
```
{: id="20210130023200-gws6p70"}

#### 参数介绍
{: id="20210130023200-03jicj8"}

* {: id="20210130023200-vv92301"}listen - 定义 Nginx 将侦听的端口。
* {: id="20210130023200-fgxny5b"}root - 定义存储网站服务的文档根目录。
* {: id="20210130023200-18ns168"}index- 配置 Nginx 请求索引文件时优先处理 index.php 命名的文件。
* {: id="20210130023200-fe1y4so"}server_name - 将此指令指向服务器的域名或公共 IP 地址。
* {: id="20210130023200-e4imsfr"}location /- 第一个位置块包括一个 try_files 指令，该指令检查是否存在满足 URI 请求的文件。如果 Nginx 找不到合适的文件，则会返回 404 错误。
* {: id="20210130023200-3to3exi"}location ~ .php$- 此位置块通过将 Nginx 指向 fastcgi-php.conf 配置文件和 php7.2-fpm.sock 文件来处理实际的 PHP 处理，该文件声明了与哪个套接字相关联 php-fpm。检查/etc/php/7.0/fpm/pool.d/www.conf 文件并查找“listen”行。
* {: id="20210130023200-gfcvfuk"}location ~ /.ht- 通过添加 deny all 指令，如果任何.htaccess 文件碰巧进入文档根目录，它们将不会被提供给访问者。
{: id="20210130023200-ie1hvwq"}

{: id="20210130113223-ugjbbvc"}

要为了让 nginx 支持 php, 需要手动设置 php-fpm 的监听路径, 文件夹 `etc/php/7.x/fpm/pool.d/www.conf` 中找到对应的监听地址.
{: id="20210130113222-hb1lkmk"}

```nginx
; The address on which to accept FastCGI requests.
; Valid syntaxes are:
;   'ip.add.re.ss:port'    - to listen on a TCP socket to a specific IPv4 address on
;                            a specific port;
;   '[ip:6:addr:ess]:port' - to listen on a TCP socket to a specific IPv6 address on
;                            a specific port;
;   'port'                 - to listen on a TCP socket to all addresses
;                            (IPv6 and IPv4-mapped) on a specific port;
;   '/path/to/unix/socket' - to listen on a unix socket.
; Note: This value is mandatory.
# 就是这个地址
listen = /run/php/php7.4-fpm.sock

```
{: id="20210130113437-gb3r1lu"}

记住这个地址跳转到 `/etc/nginx/sites-enabled/default` 路径修改配置文件
{: id="20210130113519-9yg9r8e"}

#### 修改 Nginx 配置文件
{: id="20210130023200-olm6ehb"}

1. {: id="20210130023200-tebqlsk"}将 root(网站根目录) 设置放在外面
2. {: id="20210130023200-5w3p4r4"}将 index 设置放在外面
3. {: id="20210130023200-ucz01fs"}打开.php 文件的解析设置内容。就是“ location ~ .php$ { … }”这一段内容
{: id="20210130023200-3lmm65m"}

```nginx
# 修改默认路径
root /home/www/;

        # Add index.php to the list if you are using PHP
# 添加php文件支持
        index index.html index.htm index.php;

        server_name _;

        location / {
                # First attempt to serve request as file, then
                # as directory, then fall back to displaying a 404.
# 修改无法访问指向
                try_files $uri $uri/ =404;
        }

        # pass PHP scripts to FastCGI server
        #
# 设置php文件监听
        location ~ \.php$ {
                include snippets/fastcgi-php.conf;
        #
        #       # With php-fpm (or other unix sockets):
	#	此处路径为对于php-fpm下的wwww.conf中的监听路径
                fastcgi_pass unix:/run/php/php7.4-fpm.sock;
        #       # With php-cgi (or other tcp sockets):
        #       fastcgi_pass 127.0.0.1:9000;
        }
```
{: id="20210130113726-6i1xkzm"}

{: id="20210130023200-vbd7bto"}

{: id="20210130113852-o08w0el"}

> php-fpm 的 fpm 指 FastCGI Process Manager：FastCGI 进程管理器，是一种面向高负载的 PHP 解释器。现在算是主流的 PHP 解释器。关于 PHP-FPM 更多的资料可以参考 [nginx 如何解析 php 文件 php-fpm 的解释](https://www.jianshu.com/p/f7fd7aa6c1c6)。
> {: id="20210130023200-pwgpn4t"}
{: id="20210130023200-m1xe70q"}

#### 测试启动
{: id="20210130023200-983ijni"}

```shell
# 测试配置文件是否正常
nginx -t
# 如果报告了任何错误，请返回并重新检查您的文件，然后再继续。

# 重新加载Nginx的配置文件
/etc/init.d/nginx reload


```
{: id="20210130023200-r74jppg"}

{: id="20210130023200-5mq8h62"}

### 安装 mysql
{: id="20210130023159-elfy221"}

```shell
apt install mysql-client mysql-server

/etc/init.d/mysql start

mysqladmin -u root -p password 123456

/etc/init.d/mysql restart
```
{: id="20210130114727-8sxc6jx"}

{: id="20210130023158-r47kl30"}

### 运行在公网下
{: id="20210130005042-bauy9y1"}

如果已经申请过了公网 ip 可以进行以下操作将自己的服务在公网可见.
{: id="20210130005057-4ervsuy"}

方法一:主机和光猫直接连接
{: id="20210130005139-g311q1t"}

直接将主机与光猫相连,这样就可以直接访问对于的 ip+ 端口到自己的服务器
{: id="20210130005150-9x9v49b"}

方法二:主机与路由器连接
{: id="20210130005236-1lnzg84"}

需要在路由器中手动配置以下 DMZ,这样就能让对于路由器的 ip 分配地址直接能够在互联网上访问
{: id="20210130005307-xoi7kzc"}

![](assets/tplink-dmz-host-setting.png)
{: id="20210130005420-d6cw4qg"}


{: id="20210130001809-7h4gs4n" type="doc"}
